{% extends 'base.html' %} {% block title %}Yeni Abone{% endblock %} {% block
page_title %}Yeni Abone Kaydı{% endblock %} {% set breadcrumb = [{'name':
'Aboneler', 'url': url_for('subscribers.index')}, {'name': 'Yeni Abone'}] %} {%
block content %}
<div class="card">
  <div class="card-header">
    <h3 class="card-title">Abone ve Sözleşme Bilgileri</h3>
  </div>
  <div class="card-body">
    <form id="subscriberForm">
      <div class="grid grid-cols-2 gap-4">
        <div class="form-group">
          <label class="form-label">Abone Tipi *</label>
          <select class="form-select" name="subscriber_type" required>
            <option value="Sanayi">Sanayi</option>
            <option value="Ticarethane">Ticarethane</option>
            <option value="Mesken">Mesken</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Unvan / İsim *</label>
          <input type="text" class="form-input" name="name" placeholder="Firma veya kişi adı" required />
        </div>
        <div class="form-group">
          <label class="form-label">Vergi No / TC Kimlik</label>
          <input type="text" class="form-input" name="tax_no" placeholder="1234567890" />
        </div>
        <div class="form-group">
          <label class="form-label">Vergi Dairesi</label>
          <input type="text" class="form-input" name="tax_office" placeholder="Vergi dairesi adı" />
        </div>
        <div class="form-group">
          <label class="form-label">Telefon</label>
          <input type="tel" class="form-input" name="phone" placeholder="0555 123 4567" />
        </div>
        <div class="form-group">
          <label class="form-label">E-posta</label>
          <input type="email" class="form-input" name="email" placeholder="email@example.com" />
        </div>
        <div class="form-group" style="grid-column: span 2">
          <label class="form-label">Adres</label>
          <textarea class="form-textarea" rows="2" name="address" placeholder="Tam adres..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Sektör</label>
          <input type="text" class="form-input" name="sector" placeholder="Gıda, Tekstil, Kimya..." />
        </div>
        <div class="form-group">
          <label class="form-label">Ada</label>
          <input type="number" class="form-input" name="ada" placeholder="Ada no" />
        </div>
        <div class="form-group">
          <label class="form-label">Parsel</label>
          <input type="number" class="form-input" name="parsel" placeholder="Parsel no" />
        </div>
        <div class="form-group">
          <label class="form-label">Alan (m²)</label>
          <input type="number" class="form-input" name="area_m2" placeholder="m²" />
        </div>
        <div class="form-group">
          <label class="form-label">Tarife *</label>
          <select class="form-select" name="tariff_id" required>
            <option value="">Seçiniz...</option>
            {% for tariff in tariffs %}
            <option value="{{ tariff.id }}">{{ tariff.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Sözleşme Gücü (kW)</label>
          <input type="number" class="form-input" name="contract_demand" step="0.01" placeholder="kW" />
        </div>
      </div>
      <div style="display: flex; gap: 12px; margin-top: 20px">
        <button type="submit" class="btn btn-primary">Kaydet</button>
        <a href="{{ url_for('subscribers.list') }}" class="btn btn-secondary">İptal</a>
      </div>
    </form>
  </div>
</div>

<script>
  document.getElementById( 'subscriberForm' ).addEventListener( 'submit', function ( e ) {
    e.preventDefault();
    const formData = new FormData( this );
    const data = Object.fromEntries( formData.entries() );
    ['ada', 'parsel', 'area_m2', 'contract_demand', 'tariff_id'].forEach( function ( k ) {
      if ( data[k] === '' ) return;
      data[k] = Number( data[k] );
    } );

    fetch( '{{ url_for('subscribers.api_create') }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify( data )
    } )
      .then( r => r.json() )
      .then( r => {
        if ( !r.success ) throw new Error( r.error || 'Hata' );
        window.location.href = '{{ url_for('subscribers.list') }}';
      } )
      .catch( err => alert( 'Hata: ' + err.message ) );
  } );
</script>
{% endblock %}