{% extends 'base.html' %}
{% block title %}Mevzuat Botu{% endblock %}
{% block page_title %}Mevzuat Botu{% endblock %}
{% set breadcrumb = [{'name': 'AkÄ±llÄ± Sistemler', 'url': url_for('smart.index')}, {'name': 'Mevzuat Botu'}] %}
{% block content %}
<div class="grid grid-cols-3 gap-4 mb-4">
    <div class="kpi-card">
        <div class="kpi-card-value">{{ stats.total_sources or 0 }}</div>
        <div class="kpi-card-label">Toplam Kaynak</div>
    </div>
    <div class="kpi-card">
        <div class="kpi-card-value">{{ stats.total_alerts or 0 }}</div>
        <div class="kpi-card-label">Toplam UyarÄ±</div>
    </div>
    <div class="kpi-card">
        <div class="kpi-card-value" style="color: var(--color-success)">âœ“ Uyumlu</div>
        <div class="kpi-card-label">Sistem Durumu</div>
    </div>
</div>

<div class="grid grid-cols-2 gap-4">
    <!-- Mevzuat AsistanÄ± -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">ğŸ¤– EPDK Mevzuat AsistanÄ±</h3>
        </div>
        <div class="card-body">
            <div id="chatContainer"
                style="height: 400px; overflow-y: auto; padding: 16px; background: var(--color-bg-page); border-radius: var(--radius-md); margin-bottom: 16px;">
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <div
                        style="width: 36px; height: 36px; background: var(--color-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">
                        ğŸ¤–</div>
                    <div
                        style="flex: 1; background: white; padding: 12px 16px; border-radius: 12px; border-top-left-radius: 0;">
                        <p style="margin: 0; color: var(--color-text-primary);">Merhaba! EPDK mevzuatÄ± hakkÄ±nda
                            sorularÄ±nÄ±zÄ± yanÄ±tlayabilirim. Size nasÄ±l yardÄ±mcÄ± olabilirim?</p>
                        <div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px;">
                            <button class="btn btn-outline-primary btn-sm"
                                onclick="askQuestion('Reaktif enerji cezasÄ± nasÄ±l hesaplanÄ±r?')">Reaktif ceza
                                hesabÄ±</button>
                            <button class="btn btn-outline-primary btn-sm"
                                onclick="askQuestion('OSB daÄŸÄ±tÄ±m bedeli nedir?')">OSB daÄŸÄ±tÄ±m bedeli</button>
                            <button class="btn btn-outline-primary btn-sm"
                                onclick="askQuestion('Serbest tÃ¼ketici limiti nedir?')">Serbest tÃ¼ketici</button>
                        </div>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="questionInput" class="form-control"
                    placeholder="Mevzuat hakkÄ±nda bir soru sorun..." style="flex: 1;">
                <button class="btn btn-primary" onclick="askQuestion()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13" />
                        <path d="M22 2L15 22L11 13L2 9L22 2Z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Son Mevzuat GÃ¼ncellemeleri -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">ğŸ“‹ Son Mevzuat GÃ¼ncellemeleri</h3>
        </div>
        <div class="card-body" style="padding: 0;">
            <div style="max-height: 480px; overflow-y: auto;">
                {% if recent_alerts %}
                {% for alert in recent_alerts %}
                <div style="padding: 16px; border-bottom: 1px solid var(--color-border);">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <div style="font-weight: 600; color: var(--color-text-primary);">{{ alert.title }}</div>
                            <div style="font-size: 0.875rem; color: var(--color-text-secondary); margin-top: 4px;">{{
                                alert.summary or 'Yeni g\xfcncelleme' }}</div>
                        </div>
                        {% if alert.is_important %}
                        <span class="badge"
                            style="background: var(--color-warning-bg); color: var(--color-warning);">\xd6nemli</span>
                        {% else %}
                        <span class="badge"
                            style="background: var(--color-bg-tertiary); color: var(--color-text-secondary);">Bilgi</span>
                        {% endif %}
                    </div>
                    <div style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 8px;">{{
                        alert.created_at.strftime('%d %B %Y') if alert.created_at else '-' }}</div>
                </div>
                {% endfor %}
                {% else %}
                <div style="padding: 32px; text-align: center; color: var(--color-text-secondary);">
                    Hi\xe7 uyar\u0131 bulunamad\u0131
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function askQuestion( question ) {
        var input = document.getElementById( 'questionInput' );
        var container = document.getElementById( 'chatContainer' );
        var q = question || input.value.trim();

        if ( !q ) return;

        // KullanÄ±cÄ± mesajÄ±
        container.innerHTML += `
    <div style="display: flex; gap: 12px; margin-bottom: 16px; justify-content: flex-end;">
      <div style="max-width: 70%; background: var(--color-primary); color: white; padding: 12px 16px; border-radius: 12px; border-top-right-radius: 0;">
        <p style="margin: 0;">${q}</p>
      </div>
    </div>
  `;

        input.value = '';
        container.scrollTop = container.scrollHeight;

        // SimÃ¼le edilmiÅŸ yanÄ±t
        setTimeout( () => {
            var answers = {
                'Reaktif enerji cezasÄ± nasÄ±l hesaplanÄ±r?': 'EPDK mevzuatÄ±na gÃ¶re, reaktif enerji cezasÄ± ÅŸu ÅŸekilde hesaplanÄ±r:<br><br>1. GÃ¼Ã§ faktÃ¶rÃ¼ (cos Ï†) 0.90\'Ä±n altÄ±na dÃ¼ÅŸtÃ¼ÄŸÃ¼nde ceza uygulanÄ±r<br>2. Fazla reaktif = Toplam Reaktif - (Aktif Enerji Ã— 0.484)<br>3. Ceza TutarÄ± = Fazla Reaktif Ã— Reaktif Birim FiyatÄ±<br><br>Mevcut sistemde reaktif birim fiyatÄ±: 0.89 TL/kVArh',
                'OSB daÄŸÄ±tÄ±m bedeli nedir?': 'OSB DaÄŸÄ±tÄ±m Bedeli, OSB\'nin elektrik altyapÄ±sÄ±nÄ± iÅŸletme maliyetlerini karÅŸÄ±lamak iÃ§in EPDK tarafÄ±ndan onaylanan bedeldir.<br><br>â€¢ Mevcut oran: 0.25 TL/kWh<br>â€¢ Toplam tÃ¼ketime uygulanÄ±r<br>â€¢ Faturada ayrÄ± kalem olarak gÃ¶sterilir<br><br>Bu bedel, OSB iÃ§i trafo, kablo ve ÅŸalt tesislerinin bakÄ±m-onarÄ±m giderlerini kapsar.',
                'Serbest tÃ¼ketici limiti nedir?': '2026 yÄ±lÄ± iÃ§in serbest tÃ¼ketici limiti yÄ±llÄ±k 1.000 kWh olarak belirlenmiÅŸtir.<br><br>Bu limiti aÅŸan tÃ¼keticiler:<br>â€¢ TedarikÃ§i seÃ§me hakkÄ±na sahiptir<br>â€¢ Ä°kili anlaÅŸma yapabilir<br>â€¢ Piyasa fiyatÄ±ndan elektrik alabilir<br><br>OSB katÄ±lÄ±mcÄ±larÄ± iÃ§in bu limit Ã¶zellikle Ã¶nemlidir.'
            };

            var answer = answers[q] || 'Bu konuda detaylÄ± bilgi iÃ§in EPDK resmi sitesini ziyaret edebilir veya mevzuat veritabanÄ±nda arama yapabilirsiniz. Size baÅŸka bir konuda yardÄ±mcÄ± olabilir miyim?';

            container.innerHTML += `
      <div style="display: flex; gap: 12px; margin-bottom: 16px;">
        <div style="width: 36px; height: 36px; background: var(--color-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; flex-shrink: 0;">ğŸ¤–</div>
        <div style="flex: 1; background: white; padding: 12px 16px; border-radius: 12px; border-top-left-radius: 0;">
          <p style="margin: 0; color: var(--color-text-primary);">${answer}</p>
        </div>
      </div>
    `;
            container.scrollTop = container.scrollHeight;
        }, 800 );
    }

    document.getElementById( 'questionInput' ).addEventListener( 'keypress', function ( e ) {
        if ( e.key === 'Enter' ) askQuestion();
    } );
</script>
{% endblock %}