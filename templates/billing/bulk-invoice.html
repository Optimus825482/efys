{% extends 'base.html' %}
{% block title %}Toplu Fatura{% endblock %}
{% block page_title %}Toplu Fatura Kesimi{% endblock %}
{% set breadcrumb = [{'name': 'Faturalama', 'url': url_for('billing.index')}, {'name': 'Toplu Fatura'}] %}

{% block content %}
<div class="alert alert-warning mb-4">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10" />
        <line x1="12" y1="8" x2="12" y2="12" />
        <line x1="12" y1="16" x2="12.01" y2="16" />
    </svg>
    <div>
        <strong>Dikkat:</strong> Bu işlem tüm seçili aboneler için fatura kesecektir. İşlem geri alınamaz.
    </div>
</div>

<div class="grid grid-cols-3 gap-4">
    <div class="card" style="grid-column: span 2">
        <div class="card-header">
            <h3 class="card-title">Fatura Kesim Ayarları</h3>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label">Fatura Dönemi</label>
                    <select class="form-select" id="period-select">
                        <option value="">Dönem Seçin</option>
                        {% for period in periods %}
                        <option value="{{ period.id }}" {{ 'selected' if period.status=='open' else '' }}>
                            {{ period.period_name if period.period_name else period.name if period.name else 'Dönem ' ~
                            period.id }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Vade Tarihi</label>
                    <input type="date" class="form-input" id="due-date" value="2026-02-15" />
                </div>
                <div class="form-group">
                    <label class="form-label">Abone Grubu</label>
                    <select class="form-select" id="subscriber-group">
                        <option value="all">Tümü ({{ stats.total_subscribers }} abone)</option>
                        {% for sector in stats.sectors %}
                        <option value="{{ sector.sector }}">{{ sector.sector }} ({{ sector.count }} abone)</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tarife</label>
                    <select class="form-select" id="tariff-select">
                        <option value="">Otomatik (Abone bazlı)</option>
                        {% for tariff in tariffs %}
                        <option value="{{ tariff.id }}">{{ tariff.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--color-border);" />

            <div style="display: flex; gap: 12px">
                <button class="btn btn-secondary" id="preview-btn" onclick="previewBulk()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg>
                    Önizleme Oluştur
                </button>
                <button class="btn btn-cta" id="create-btn" onclick="createBulkInvoices()" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
                        <path d="M14 2v6h6" />
                    </svg>
                    Toplu Fatura Kes
                </button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Özet</h3>
        </div>
        <div class="card-body">
            <div
                style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--color-border);">
                <span style="color: var(--color-text-secondary)">Toplam Abone</span>
                <span style="font-weight: 600" id="summary-subscribers">{{ stats.total_subscribers }}</span>
            </div>
            <div
                style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--color-border);">
                <span style="color: var(--color-text-secondary)">Toplam Tüketim</span>
                <span style="font-weight: 600" id="summary-consumption">{{ "{:,.0f}".format(stats.total_consumption or
                    0) }} kWh</span>
            </div>
            <div
                style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--color-border);">
                <span style="color: var(--color-text-secondary)">Tahmini Tutar</span>
                <span style="font-weight: 600; color: var(--color-primary)" id="summary-amount">₺{{
                    "{:,.2f}".format(stats.estimated_amount or 0) }}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 12px 0;">
                <span style="color: var(--color-text-secondary)">Kesilecek Fatura</span>
                <span style="font-weight: 600; color: var(--color-cta)" id="summary-invoices">0</span>
            </div>
        </div>
    </div>
</div>

<!-- Önizleme Sonuçları -->
<div id="preview-results" class="card mt-4" style="display: none;">
    <div class="card-header">
        <h3 class="card-title">Fatura Önizleme</h3>
        <span id="preview-count" style="color: var(--color-text-secondary);"></span>
    </div>
    <div class="card-body" style="padding: 0;">
        <table class="table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all" checked /></th>
                    <th>Abone Kodu</th>
                    <th>Abone Adı</th>
                    <th style="text-align: right;">T1</th>
                    <th style="text-align: right;">T2</th>
                    <th style="text-align: right;">T3</th>
                    <th style="text-align: right;">Toplam kWh</th>
                    <th style="text-align: right;">Tutar</th>
                    <th>Durum</th>
                </tr>
            </thead>
            <tbody id="preview-tbody">
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let previewData = [];

    async function previewBulk() {
        const periodId = document.getElementById( 'period-select' ).value;
        const group = document.getElementById( 'subscriber-group' ).value;

        if ( !periodId ) {
            alert( 'Lütfen dönem seçin' );
            return;
        }

        document.getElementById( 'preview-btn' ).disabled = true;
        document.getElementById( 'preview-btn' ).textContent = 'Hesaplanıyor...';

        try {
            const params = new URLSearchParams( { period_id: periodId } );
            if ( group !== 'all' ) params.append( 'sector', group );

            const res = await fetch( `/billing/api/calculate?${params}` );
            const data = await res.json();

            if ( !data.success ) {
                alert( 'Hata: ' + ( data.error || 'Bilinmeyen hata' ) );
                return;
            }

            previewData = data.data;
            displayPreview( previewData );

            document.getElementById( 'create-btn' ).disabled = false;

        } catch ( err ) {
            alert( 'Önizleme hatası: ' + err.message );
        } finally {
            document.getElementById( 'preview-btn' ).disabled = false;
            document.getElementById( 'preview-btn' ).innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
            Önizleme Oluştur
        `;
        }
    }

    function displayPreview( results ) {
        document.getElementById( 'preview-results' ).style.display = 'block';
        document.getElementById( 'preview-count' ).textContent = `${results.length} abone`;

        const tbody = document.getElementById( 'preview-tbody' );
        tbody.innerHTML = '';

        let totalAmount = 0;
        let validCount = 0;

        results.forEach( r => {
            const total = ( r.t1_consumption || 0 ) + ( r.t2_consumption || 0 ) + ( r.t3_consumption || 0 );
            const isValid = r.status === 'ok' && total > 0;
            if ( isValid ) {
                totalAmount += r.total_amount || 0;
                validCount++;
            }

            tbody.innerHTML += `
            <tr>
                <td><input type="checkbox" class="invoice-check" data-id="${r.subscriber_id}" ${isValid ? 'checked' : 'disabled'} /></td>
                <td><strong>${r.subscriber_code}</strong></td>
                <td>${r.subscriber_name}</td>
                <td style="text-align: right;">${formatNumber( r.t1_consumption || 0 )}</td>
                <td style="text-align: right;">${formatNumber( r.t2_consumption || 0 )}</td>
                <td style="text-align: right;">${formatNumber( r.t3_consumption || 0 )}</td>
                <td style="text-align: right;"><strong>${formatNumber( total )}</strong></td>
                <td style="text-align: right;">${formatCurrency( r.total_amount || 0 )}</td>
                <td><span class="badge badge-${isValid ? 'success' : 'warning'}">${isValid ? 'Hazır' : 'Veri Yok'}</span></td>
            </tr>
        `;
        } );

        document.getElementById( 'summary-invoices' ).textContent = validCount;
        document.getElementById( 'summary-amount' ).textContent = formatCurrency( totalAmount );
    }

    document.getElementById( 'select-all' )?.addEventListener( 'change', function () {
        document.querySelectorAll( '.invoice-check:not(:disabled)' ).forEach( cb => cb.checked = this.checked );
    } );

    async function createBulkInvoices() {
        const periodId = document.getElementById( 'period-select' ).value;
        const selectedIds = Array.from( document.querySelectorAll( '.invoice-check:checked' ) )
            .map( cb => parseInt( cb.dataset.id ) );

        if ( !selectedIds.length ) {
            alert( 'En az bir abone seçin' );
            return;
        }

        if ( !confirm( `${selectedIds.length} abone için fatura kesilecek. Onaylıyor musunuz?` ) ) return;

        try {
            const res = await fetch( '/billing/api/create-bulk-invoices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify( { period_id: periodId, subscriber_ids: selectedIds } )
            } );

            const data = await res.json();
            if ( data.success ) {
                alert( `${data.created} fatura başarıyla oluşturuldu` );
                location.href = '/billing/';
            } else {
                alert( 'Hata: ' + ( data.error || 'Bilinmeyen hata' ) );
            }
        } catch ( err ) {
            alert( 'Fatura oluşturma hatası: ' + err.message );
        }
    }

    function formatNumber( n ) {
        return new Intl.NumberFormat( 'tr-TR' ).format( n || 0 );
    }

    function formatCurrency( n ) {
        return new Intl.NumberFormat( 'tr-TR', { style: 'currency', currency: 'TRY' } ).format( n || 0 );
    }
</script>
{% endblock %}