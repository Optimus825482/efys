{% extends 'base.html' %} {% block title %}Fatura YazdÄ±r{% endblock %} {% block
page_title %}Fatura YazdÄ±r / PDF{% endblock %} {% set breadcrumb = [{'name':
'Faturalama', 'url': url_for('billing.index')}, {'name': 'YazdÄ±r/PDF'}] %} {%
block content %}

{% if invoice %}
<!-- YazdÄ±rÄ±labilir Fatura -->
<div class="card print-container" id="printable-invoice" style="max-width: 210mm; margin: 0 auto;">
  <div class="card-body" style="padding: 15mm;">
    <!-- Fatura BaÅŸlÄ±ÄŸÄ± -->
    <div
      style="display: flex; justify-content: space-between; border-bottom: 2px solid #1a56db; padding-bottom: 16px; margin-bottom: 20px;">
      <div>
        <h1 style="font-size: 18px; font-weight: 700; color: #1a56db; margin: 0;">GÃ–NEN ORGANÄ°ZE SANAYÄ° BÃ–LGESÄ°</h1>
        <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">OSB DaÄŸÄ±tÄ±m LisansÄ±: EDL-2006-0XXX<br>Elektrik
          FaturalandÄ±rma ve YÃ¶netim Sistemi</div>
      </div>
      <div style="text-align: right;">
        <div style="font-size: 14px; font-weight: 700; margin-bottom: 4px;">ELEKTRÄ°K FATURASI</div>
        <div style="font-size: 12px; font-weight: 600; color: #1a56db;">{{ invoice.invoice_no }}</div>
        <div style="font-size: 10px; color: #6b7280;">DÃ¼zenleme: {{ invoice.issue_date.strftime('%d.%m.%Y') if
          invoice.issue_date else 'N/A' }}</div>
      </div>
    </div>

    <!-- Abone ve SayaÃ§ Bilgileri -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; font-size: 11px;">
      <div style="background: #f9fafb; padding: 12px; border-radius: 4px;">
        <div style="font-size: 10px; font-weight: 600; color: #6b7280; margin-bottom: 8px; text-transform: uppercase;">
          Abone Bilgileri</div>
        <table style="width: 100%;">
          <tr>
            <td style="color: #6b7280; padding: 2px 0;">Abone No:</td>
            <td style="font-weight: 600; text-align: right;">{{ invoice.subscriber_code }}</td>
          </tr>
          <tr>
            <td style="color: #6b7280; padding: 2px 0;">Unvan:</td>
            <td style="font-weight: 600; text-align: right;">{{ invoice.subscriber_name }}</td>
          </tr>
          <tr>
            <td style="color: #6b7280; padding: 2px 0;">Vergi No:</td>
            <td style="text-align: right;">{{ invoice.tax_no or '-' }}</td>
          </tr>
          <tr>
            <td style="color: #6b7280; padding: 2px 0;">Adres:</td>
            <td style="text-align: right; font-size: 10px;">{{ invoice.address or '-' }}</td>
          </tr>
        </table>
      </div>
      <div style="background: #f9fafb; padding: 12px; border-radius: 4px;">
        <div style="font-size: 10px; font-weight: 600; color: #6b7280; margin-bottom: 8px; text-transform: uppercase;">
          SayaÃ§ ve DÃ¶nem</div>
        <table style="width: 100%;">
          <tr>
            <td style="color: #6b7280; padding: 2px 0;">SayaÃ§ No:</td>
            <td style="font-weight: 600; text-align: right;">{{ invoice.meter_no or 'N/A' }}</td>
          </tr>
          <tr>
            <td style="color: #6b7280; padding: 2px 0;">Ã‡arpan:</td>
            <td style="text-align: right;">{{ invoice.multiplier or 1 }}</td>
          </tr>
          <tr>
            <td style="color: #6b7280; padding: 2px 0;">DÃ¶nem:</td>
            <td style="font-weight: 600; text-align: right;">{{ invoice.period_name }}</td>
          </tr>
          <tr>
            <td style="color: #6b7280; padding: 2px 0;">Tarih AralÄ±ÄŸÄ±:</td>
            <td style="text-align: right;">{{ invoice.period_start.strftime('%d.%m') }} - {{
              invoice.period_end.strftime('%d.%m.%Y') }}</td>
          </tr>
        </table>
      </div>
    </div>

    <!-- TÃ¼ketim Ã–zeti -->
    <div style="background: #eff6ff; padding: 10px 16px; border-radius: 4px; margin-bottom: 20px;">
      <div
        style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; text-align: center; font-size: 11px;">
        <div>
          <div style="color: #6b7280; font-size: 10px;">T1 (GÃ¼ndÃ¼z)</div>
          <div style="font-weight: 700; color: #1a56db;">{{ "{:,.0f}".format(invoice.t1_consumption or 0) }} kWh</div>
        </div>
        <div>
          <div style="color: #6b7280; font-size: 10px;">T2 (Puant)</div>
          <div style="font-weight: 700; color: #f59e0b;">{{ "{:,.0f}".format(invoice.t2_consumption or 0) }} kWh</div>
        </div>
        <div>
          <div style="color: #6b7280; font-size: 10px;">T3 (Gece)</div>
          <div style="font-weight: 700; color: #10b981;">{{ "{:,.0f}".format(invoice.t3_consumption or 0) }} kWh</div>
        </div>
        <div style="border-left: 1px solid #d1d5db; padding-left: 12px;">
          <div style="color: #6b7280; font-size: 10px;">Toplam</div>
          <div style="font-weight: 700; font-size: 14px;">{{ "{:,.0f}".format(invoice.total_consumption or 0) }} kWh
          </div>
        </div>
        <div>
          <div style="color: #6b7280; font-size: 10px;">Max Demant</div>
          <div style="font-weight: 700;">{{ "{:,.1f}".format(invoice.max_demand or 0) }} kW</div>
        </div>
      </div>
    </div>

    <!-- Fatura Kalemleri Tablosu -->
    <table style="width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 16px;">
      <thead>
        <tr style="background: #f3f4f6;">
          <th style="text-align: left; padding: 8px; border: 1px solid #e5e7eb;">AÃ§Ä±klama</th>
          <th style="text-align: right; padding: 8px; border: 1px solid #e5e7eb;">Miktar</th>
          <th style="text-align: right; padding: 8px; border: 1px solid #e5e7eb;">Birim</th>
          <th style="text-align: right; padding: 8px; border: 1px solid #e5e7eb;">Birim Fiyat</th>
          <th style="text-align: right; padding: 8px; border: 1px solid #e5e7eb;">Tutar (TL)</th>
        </tr>
      </thead>
      <tbody>
        {% for item in invoice.items %}
        <tr>
          <td style="padding: 6px 8px; border: 1px solid #e5e7eb;">{{ item.description }}</td>
          <td style="text-align: right; padding: 6px 8px; border: 1px solid #e5e7eb;">{{ "{:,.2f}".format(item.quantity
            or 0) }}</td>
          <td style="text-align: right; padding: 6px 8px; border: 1px solid #e5e7eb;">{{ item.unit or 'kWh' }}</td>
          <td style="text-align: right; padding: 6px 8px; border: 1px solid #e5e7eb;">â‚º{{
            "{:,.4f}".format(item.unit_price or 0) }}</td>
          <td style="text-align: right; padding: 6px 8px; border: 1px solid #e5e7eb; font-weight: 600;">â‚º{{
            "{:,.2f}".format(item.total_amount or 0) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Toplam -->
    <div style="display: flex; justify-content: flex-end;">
      <div style="width: 250px; border: 1px solid #e5e7eb; border-radius: 4px; overflow: hidden; font-size: 11px;">
        <div
          style="display: flex; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid #e5e7eb; background: #f9fafb;">
          <span>Ara Toplam</span>
          <span style="font-weight: 600;">â‚º{{ "{:,.2f}".format(invoice.subtotal or 0) }}</span>
        </div>
        {% if invoice.btv_amount %}
        <div
          style="display: flex; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid #e5e7eb;">
          <span>BTV (%5)</span>
          <span style="font-weight: 600;">â‚º{{ "{:,.2f}".format(invoice.btv_amount or 0) }}</span>
        </div>
        {% endif %}
        <div
          style="display: flex; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid #e5e7eb;">
          <span>KDV (%{{ invoice.vat_rate|int }})</span>
          <span style="font-weight: 600;">â‚º{{ "{:,.2f}".format(invoice.vat_amount or 0) }}</span>
        </div>
        <div
          style="display: flex; justify-content: space-between; padding: 12px; background: #1a56db; color: white; font-size: 14px;">
          <span style="font-weight: 700;">GENEL TOPLAM</span>
          <span style="font-weight: 700;">â‚º{{ "{:,.2f}".format(invoice.total_amount or 0) }}</span>
        </div>
      </div>
    </div>

    <!-- Ã–deme Bilgileri -->
    <div
      style="margin-top: 20px; padding: 12px; background: #f9fafb; border-radius: 4px; border-left: 3px solid #1a56db; font-size: 10px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div>
          <div style="font-weight: 600; margin-bottom: 4px;">Ã–deme Bilgileri</div>
          <div style="color: #6b7280;">
            Banka: Ziraat BankasÄ± - GÃ¶nen Åubesi<br>
            IBAN: TR00 0000 0000 0000 0000 0000 00<br>
            AÃ§Ä±klama: {{ invoice.subscriber_code }} - {{ invoice.period_name }}
          </div>
        </div>
        <div style="text-align: right;">
          <div style="font-weight: 600; margin-bottom: 4px;">Son Ã–deme Tarihi</div>
          <div style="font-size: 16px; font-weight: 700; color: #1a56db;">{{ invoice.due_date.strftime('%d.%m.%Y') if
            invoice.due_date else 'N/A' }}</div>
          <div style="font-size: 9px; color: #6b7280; margin-top: 2px;">Gecikme faizi uygulanÄ±r</div>
        </div>
      </div>
    </div>

    <!-- Yasal Bilgiler -->
    <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid #e5e7eb; font-size: 8px; color: #9ca3af;">
      <p style="margin-bottom: 4px;"><strong>EPDK MevzuatÄ±:</strong> Bu fatura, "Organize Sanayi BÃ¶lgelerinin Elektrik
        PiyasasÄ± Faaliyetlerine Ä°liÅŸkin YÃ¶netmelik" hÃ¼kÃ¼mlerine uygun olarak dÃ¼zenlenmiÅŸtir.</p>
      <p><strong>Ä°tiraz:</strong> Faturaya iliÅŸkin itirazlar 15 gÃ¼n iÃ§inde yazÄ±lÄ± olarak OSB MÃ¼dÃ¼rlÃ¼ÄŸÃ¼'ne yapÄ±lmalÄ±dÄ±r.
      </p>
    </div>
  </div>
</div>

<!-- YazdÄ±rma ButonlarÄ± -->
<div class="card" style="max-width: 210mm; margin: 20px auto;">
  <div class="card-body" style="display: flex; justify-content: space-between; gap: 12px;">
    <button class="btn btn-secondary" onclick="window.history.back()">â† Geri</button>
    <div style="display: flex; gap: 12px;">
      <button class="btn btn-outline-primary" onclick="window.print()">ğŸ–¨ï¸ YazdÄ±r</button>
      <button class="btn btn-primary" onclick="downloadPDF()">ğŸ“„ PDF Ä°ndir</button>
    </div>
  </div>
</div>

<style>
  @media print {
    body * {
      visibility: hidden;
    }

    #printable-invoice,
    #printable-invoice * {
      visibility: visible;
    }

    #printable-invoice {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
    }

    .card:not(#printable-invoice),
    .sidebar,
    .header,
    .breadcrumb {
      display: none !important;
    }
  }
</style>

<script>
  function downloadPDF() {
    alert( 'PDF indirme Ã¶zelliÄŸi yakÄ±nda eklenecek.\n\nÅimdilik "YazdÄ±r" butonunu kullanarak PDF olarak kaydedebilirsiniz.' );
  }
</script>

{% else %}
<!-- Fatura SeÃ§im EkranÄ± -->
<div class="card">
  <div class="card-header">
    <h3 class="card-title">Fatura YazdÄ±rma</h3>
  </div>
  <div class="card-body">
    <div class="grid grid-cols-2 gap-4">
      <div class="form-group">
        <label class="form-label">DÃ¶nem SeÃ§</label>
        <select class="form-select" id="period-select">
          <option value="">-- DÃ¶nem SeÃ§in --</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Abone Grubu</label>
        <select class="form-select" id="group-select">
          <option value="">TÃ¼mÃ¼</option>
          <option value="Sanayi">Sanayi</option>
          <option value="Ticarethane">Ticarethane</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Format</label>
        <select class="form-select" id="format-select">
          <option value="pdf">PDF</option>
          <option value="excel">Excel</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">SÄ±ralama</label>
        <select class="form-select" id="sort-select">
          <option value="name">Abone AdÄ± (A-Z)</option>
          <option value="invoice_no">Fatura No</option>
          <option value="amount">Tutar (BÃ¼yÃ¼kten KÃ¼Ã§Ã¼ÄŸe)</option>
        </select>
      </div>
    </div>

    <!-- Fatura Listesi -->
    <div id="invoice-list" style="margin-top: 20px;">
      <div style="text-align: center; padding: 40px; color: var(--color-text-muted);">
        DÃ¶nem seÃ§erek faturalarÄ± listeleyin
      </div>
    </div>

    <div style="display: flex; gap: 12px; margin-top: 16px">
      <button class="btn btn-primary" onclick="generateBulkPDF()">ğŸ“„ Toplu PDF OluÅŸtur</button>
      <button class="btn btn-secondary" onclick="exportExcel()">ğŸ“Š Excel Ä°ndir</button>
    </div>
  </div>
</div>

<script>
  // DÃ¶nemleri yÃ¼kle
  fetch( '/billing/api/periods' )
    .then( r => r.json() )
    .then( data => {
      if ( data.success ) {
        const select = document.getElementById( 'period-select' );
        data.data.forEach( p => {
          select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
        } );
      }
    } );

  document.getElementById( 'period-select' ).addEventListener( 'change', function () {
    const periodId = this.value;
    if ( !periodId ) return;

    fetch( `/billing/api/invoices/period/${periodId}` )
      .then( r => r.json() )
      .then( data => {
        const container = document.getElementById( 'invoice-list' );
        if ( data.success && data.data.length > 0 ) {
          let html = '<div class="table-responsive"><table class="table"><thead><tr><th>Fatura No</th><th>Abone</th><th>Tutar</th><th>Durum</th><th></th></tr></thead><tbody>';
          data.data.forEach( inv => {
            html += `<tr>
            <td>${inv.invoice_no}</td>
            <td>${inv.subscriber_code} - ${inv.subscriber_name}</td>
            <td style="font-weight:600;">â‚º${inv.total_amount.toLocaleString( 'tr-TR', { minimumFractionDigits: 2 } )}</td>
            <td><span class="badge badge-${inv.status === 'paid' ? 'success' : 'warning'}">${inv.status}</span></td>
            <td><a href="/billing/print/${inv.id}" class="btn btn-sm btn-outline-primary">YazdÄ±r</a></td>
          </tr>`;
          } );
          html += '</tbody></table></div>';
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--color-text-muted);">Bu dÃ¶nemde fatura bulunamadÄ±</div>';
        }
      } );
  } );

  function generateBulkPDF() {
    alert( 'Toplu PDF oluÅŸturma Ã¶zelliÄŸi yakÄ±nda eklenecek.' );
  }

  function exportExcel() {
    alert( 'Excel indirme Ã¶zelliÄŸi yakÄ±nda eklenecek.' );
  }
</script>
{% endif %}
{% endblock %}