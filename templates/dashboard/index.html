{% extends 'base.html' %} {% block title %}Dashboard{% endblock %} {% block
page_title %}Dashboard{% endblock %} {% block content %}
<!-- KPI Cards -->
<div class="grid grid-cols-4 gap-4 mb-4">
  <!-- Toplam Abone -->
  <div class="kpi-card">
    <div class="kpi-card-icon primary">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
        <circle cx="9" cy="7" r="4" />
        <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75" />
      </svg>
    </div>
    <div class="kpi-card-value">{{ kpis.total_subscribers.value }}</div>
    <div class="kpi-card-label">
      Toplam Abone
    </div>
    <div class="kpi-card-change positive">
      {{ kpis.total_subscribers.change }}
    </div>
  </div>

  <!-- AylÄ±k TÃ¼ketim -->
  <div class="kpi-card">
    <div class="kpi-card-icon success">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
      </svg>
    </div>
    <div class="kpi-card-value">{{ kpis.monthly_consumption.value }}</div>
    <div class="kpi-card-label">AylÄ±k TÃ¼ketim ({{ kpis.monthly_consumption.unit }})</div>
    <div class="kpi-card-change info">
      {{ kpis.monthly_consumption.change }}
    </div>
  </div>

  <!-- Toplam Okuma -->
  <div class="kpi-card">
    <div class="kpi-card-icon warning">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
      </svg>
    </div>
    <div class="kpi-card-value">{{ kpis.total_readings.value }}</div>
    <div class="kpi-card-label">Toplam Okuma ({{ kpis.total_readings.unit }})</div>
    <div class="kpi-card-change info">
      {{ kpis.total_readings.change }}
    </div>
  </div>

  <!-- Aktif SayaÃ§ -->
  <div class="kpi-card">
    <div class="kpi-card-icon info">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="4" width="20" height="16" rx="2" />
        <path d="M7 15h.01M11 15h2" />
        <path d="M7 11h8" />
      </svg>
    </div>
    <div class="kpi-card-value">{{ kpis.active_meters.value }}</div>
    <div class="kpi-card-label">Aktif SayaÃ§</div>
    <div class="kpi-card-change positive">
      {{ kpis.active_meters.change }}
    </div>
  </div>
</div>

<!-- Charts Row -->
<div class="grid grid-cols-3 gap-4 mb-4">
  <!-- Daily Consumption Chart -->
  <div class="card" style="grid-column: span 2">
    <div class="card-header">
      <h3 class="card-title">GÃ¼nlÃ¼k TÃ¼ketim (Son 7 GÃ¼n)</h3>
      <select class="form-select" style="width: auto; padding: 6px 12px">
        <option>Son 7 GÃ¼n</option>
        <option>Son 30 GÃ¼n</option>
        <option>Bu Ay</option>
      </select>
    </div>
    <div class="card-body">
      <div class="chart-container">
        <canvas id="consumptionChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Reactive Energy Gauge - Google Charts -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">GÃ¼Ã§ FaktÃ¶rÃ¼ (Cos Ï†)</h3>
    </div>
    <div class="card-body" style="display: flex; flex-direction: column; align-items: center">
      <div id="gaugeChart" style="width: 100%; height: 200px"></div>
      <div style="text-align: center; margin-top: 8px">
        {% if reactive %}
        <div
          class="badge {% if reactive.ortalama_cos_phi >= 0.9 %}badge-success{% elif reactive.ortalama_cos_phi >= 0.85 %}badge-warning{% else %}badge-danger{% endif %}"
          style="font-size: 0.9rem; padding: 8px 16px">
          {% if reactive.ortalama_cos_phi >= 0.9 %}Ceza Yok{% elif
          reactive.ortalama_cos_phi >= 0.85 %}Dikkat - SÄ±nÄ±ra YakÄ±n{% else
          %}Reaktif Ceza UygulanÄ±r{% endif %}
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Bottom Row -->
<div class="grid grid-cols-3 gap-4">
  <!-- Recent Alarms -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Son Alarmlar</h3>
      <a href="{{ url_for('dashboard.alarm_center') }}" class="btn btn-secondary btn-sm">TÃ¼mÃ¼nÃ¼ GÃ¶r</a>
    </div>
    <div class="card-body" style="padding: 0">
      <table class="table">
        <thead>
          <tr>
            <th>Durum</th>
            <th>Mesaj</th>
            <th>Zaman</th>
          </tr>
        </thead>
        <tbody>
          {% for alarm in alarms %}
          <tr>
            <td>
              <span class="badge badge-{{ alarm.type }}">
                {% if alarm.type == 'danger' %}Kritik{% elif alarm.type ==
                'warning' %}UyarÄ±{% else %}Bilgi{% endif %}
              </span>
            </td>
            <td>{{ alarm.message }}</td>
            <td style="color: var(--color-text-secondary)">{{ alarm.time }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Mevzuat Widget -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">ðŸ“œ Mevzuat Takip</h3>
      <a href="{{ url_for('settings.mevzuat') }}" class="btn btn-secondary btn-sm">TÃ¼mÃ¼nÃ¼ GÃ¶r</a>
    </div>
    <div class="card-body">
      {% if mevzuat and mevzuat.stats %}
      <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
        <div style="text-align: center;">
          <div style="font-size: 1.5rem; font-weight: bold; color: var(--color-danger);">{{ mevzuat.stats.unread_count
            or 0 }}</div>
          <div style="font-size: 0.75rem; color: var(--color-text-secondary);">OkunmamÄ±ÅŸ</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 1.5rem; font-weight: bold; color: var(--color-warning);">{{
            mevzuat.stats.important_count or 0 }}</div>
          <div style="font-size: 0.75rem; color: var(--color-text-secondary);">Ã–nemli</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 1.5rem; font-weight: bold; color: var(--color-primary);">{{ mevzuat.stats.week_count or
            0 }}</div>
          <div style="font-size: 0.75rem; color: var(--color-text-secondary);">Bu Hafta</div>
        </div>
      </div>
      <div style="display: flex; flex-direction: column; gap: 8px;">
        {% for alert in mevzuat.recent %}
        <a href="{{ url_for('settings.mevzuat') }}"
          style="display: block; padding: 8px; border-radius: 6px; background: {{ 'var(--color-surface-raised)' if alert.is_read else 'rgba(59, 130, 246, 0.1)' }}; text-decoration: none;">
          <div style="font-size: 0.8rem; color: var(--color-text-secondary); margin-bottom: 2px;">{{ alert.source_name
            }}</div>
          <div
            style="font-size: 0.85rem; color: var(--color-text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            {{ alert.title[:60] }}{% if alert.title|length > 60 %}...{% endif %}</div>
        </a>
        {% else %}
        <div style="text-align: center; padding: 16px; color: var(--color-text-secondary);">
          <p>HenÃ¼z mevzuat uyarÄ±sÄ± yok</p>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div style="text-align: center; padding: 16px; color: var(--color-text-secondary);">
        <p>Mevzuat takip sistemi hazÄ±r</p>
        <a href="{{ url_for('settings.mevzuat') }}" class="btn btn-secondary btn-sm"
          style="margin-top: 8px;">YapÄ±landÄ±r</a>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">HÄ±zlÄ± Ä°ÅŸlemler</h3>
    </div>
    <div class="card-body">
      <div style="display: flex; flex-direction: column; gap: 12px">
        <a href="{{ url_for('billing.calculate') }}" class="btn btn-cta w-full">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6" />
          </svg>
          Fatura Hesapla
        </a>
        <a href="{{ url_for('reports.consumption') }}" class="btn btn-secondary w-full">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
            <path d="M14 2v6h6" />
          </svg>
          Rapor OluÅŸtur
        </a>
        <a href="{{ url_for('subscribers.card') }}" class="btn btn-secondary w-full">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
            <circle cx="8.5" cy="7" r="4" />
            <line x1="20" y1="8" x2="20" y2="14" />
            <line x1="23" y1="11" x2="17" y2="11" />
          </svg>
          Yeni Abone Ekle
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<!-- Google Charts -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script>
  // Chart data from PostgreSQL
  {% if chart_data %}
  var chartLabels = {{ chart_data.labels | tojson | safe }};
  var t1Data = {{ chart_data.t1 | tojson | safe }};
  var t2Data = {{ chart_data.t2 | tojson | safe }};
  var t3Data = {{ chart_data.t3 | tojson | safe }};
  {% else %}
  var chartLabels = ["Veri Yok"];
  var t1Data = [0];
  var t2Data = [0];
  var t3Data = [0];
  {% endif %}

  // Consumption Chart with real data
  var consumptionCtx = document
    .getElementById( "consumptionChart" )
    .getContext( "2d" );
  new Chart( consumptionCtx, {
    type: "bar",
    data: {
      labels: chartLabels,
      datasets: [
        {
          label: "T1 (GÃ¼ndÃ¼z)",
          data: t1Data,
          backgroundColor: "#2563EB",
        },
        {
          label: "T2 (Puant)",
          data: t2Data,
          backgroundColor: "#F97316",
        },
        {
          label: "T3 (Gece)",
          data: t3Data,
          backgroundColor: "#10B981",
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: "top" },
        tooltip: {
          callbacks: {
            label: function ( context ) {
              return context.dataset.label + ': ' + context.raw.toLocaleString( 'tr-TR' ) + ' kWh';
            }
          }
        }
      },
      scales: {
        x: { stacked: true },
        y: {
          stacked: true,
          beginAtZero: true,
          ticks: {
            callback: function ( value ) {
              return value.toLocaleString( 'tr-TR' ) + ' kWh';
            }
          }
        },
      },
    },
  } );

  // Google Charts Gauge for Power Factor
  {% if reactive %}
  var cosPhi = {{ reactive.ortalama_cos_phi }};
  {% else %}
  var cosPhi = 0.9;
  {% endif %}

  google.charts.load( 'current', { 'packages': ['gauge'] } );
  google.charts.setOnLoadCallback( drawGauge );

  function drawGauge() {
    var data = google.visualization.arrayToDataTable( [
      ['Label', 'Value'],
      ['Cos Ï†', cosPhi]
    ] );

    var options = {
      width: 280,
      height: 200,
      min: 0.7,
      max: 1.0,
      greenFrom: 0.90,
      greenTo: 1.0,
      yellowFrom: 0.85,
      yellowTo: 0.90,
      redFrom: 0.70,
      redTo: 0.85,
      minorTicks: 5,
      majorTicks: ['0.7', '0.8', '0.9', '1.0'],
      animation: {
        duration: 1000,
        easing: 'inAndOut'
      }
    };

    var chart = new google.visualization.Gauge( document.getElementById( 'gaugeChart' ) );
    chart.draw( data, options );
  }
</script>
{% endblock %}